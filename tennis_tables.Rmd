---
title: "Tennis Tables"
author: "Shiyu Murashima"
date: "`r Sys.Date()`"
output: html_document
---

# Libraries
```{r}
library(dplyr)
library(ggplot2)
library(gt)
```

# Loading in Data
```{r}
shotdata <- read.csv("/Users/ShiyuMurashima/Desktop/UCLA\ Tennis/SpencerJohnson_AlessioBasile_Shot.csv")
pointdata <- read.csv("/Users/ShiyuMurashima/Desktop/UCLA\ Tennis/SpencerJohnson_AlessioBasile_Point_ForVisuals.csv")
player1 <- "Spencer Johnson"
player2 <- "Alessio Basile"

player_first <- "Spencer"
player_last <- "Johnson"
```

# Quick Statistics Table
```{r}
# quick_percentages <- function(data, player){
#   data$courtSide <- ifelse(data$pointScore %in% c("15-0", "15-30", "30-40", "40-0", "40-40 (Ad)",
#                                             "0-15", "30-15", "40-30", "0-40"),
#                        "Ad", 
#                        ifelse(data$pointScore %in% c("15-40", "30-0", "30-30", "15-15", "40-40 (Deuce)",
#                                                    "40-15", "0-30", "0-0"),
#                               "Deuce",
#                               NA))
#   
#   ad_serve <- data %>% 
#   filter(serverName == player & courtSide == "Ad") %>% 
#   summarise("Server Name" = player,
#             "Ad Serve Wide %" = round(((length(which(firstServeZone == "Wide")) + length(which(secondServeZone == "Wide"))) /
#               (length(which(firstServeZone != "")) + length(which(secondServeZone != ""))))*100),
#             "Ad Serve Body %" = round(((length(which(firstServeZone == "Body")) + length(which(secondServeZone == "Body"))) /
#               (length(which(firstServeZone != "")) + length(which(secondServeZone != ""))))*100),
#             "Ad Serve T %" = round(((length(which(firstServeZone == "T")) + length(which(secondServeZone == "T"))) /
#               (length(which(firstServeZone != "")) + length(which(secondServeZone != ""))))*100))
#   
#   deuce_serve <- data %>% 
#   filter(serverName == player & courtSide == "Deuce") %>% 
#   summarise("Deuce Serve Wide %" = round(((length(which(firstServeZone == "Wide")) + length(which(secondServeZone == "Wide"))) /
#               (length(which(firstServeZone != "")) + length(which(secondServeZone != ""))))*100),
#             "Deuce Serve Body %" = round(((length(which(firstServeZone == "Body")) + length(which(secondServeZone == "Body"))) /
#               (length(which(firstServeZone != "")) + length(which(secondServeZone != ""))))*100),
#             "Deuce Serve T %" = round(((length(which(firstServeZone == "T")) + length(which(secondServeZone == "T"))) /
#               (length(which(firstServeZone != "")) + length(which(secondServeZone != ""))))*100))
#   
#   cbind(ad_serve, deuce_serve)
# }

# quick_counts <- function(data, player){
#   error_table <- data %>% 
#     filter(shotHitBy == player & is.na(isWinner)) %>% 
#     summarise("Server Name" = player,
#               "FH Error Net Count" = length(which(shotFhBh == "Forehand" & isErrorNet == 1)),
#               "FH Error Wide Count" = length(which((shotFhBh == "Forehand" & (isErrorWideL == 1 | isErrorWideR == 1)))),
#               "FH Error Long Count" = length(which(shotFhBh == "Forehand" & isErrorLong == 1)),
#               "BH Error Net Count" = length(which(shotFhBh == "Backhand" & isErrorNet == 1)),
#               "BH Error Wide Count"= length(which((shotFhBh == "Backhand" & (isErrorWideL == 1 | isErrorWideR == 1)))),
#               "BH Error Long Count" = length(which(shotFhBh == "Backhand" & isErrorLong == 1)))
#   
#   net_table <- data %>% 
#     filter(shotHitBy == player) %>% 
#     summarise("Net Count" = length(which(isVolley == 1)))
#   
#   cbind(error_table, net_table)
# }

# rbind(quick_percentages(shotdata, player1), quick_percentages(shotdata, player2))
# rbind(quick_counts(shotdata, player1), quick_counts(shotdata, player2))
```

# Ace/Double Fault Count Table 
```{r}
# Supplement to Summary Stats Visualization
count_table <- function(data){
  data %>% 
    group_by(serverName) %>% 
    filter(isPointStart == 1 & isPointEnd == 1) %>% 
    summarise("Ace Count" = sum(firstServeIn == 1 | secondServeIn == 1),
              "Double Fault Count" = sum(firstServeIn != 1 & secondServeIn != 1))
}

count_table(shotdata)
```

# Approach Shot Table + Visualization
```{r}
# Approach Shot Table Function
approach_table <- function(data, player){
  df1 <- data %>% 
    reframe("approachPercent" = (length(which(isApproach == 1 & shotHitBy == player & is.na(isWinner))) /
                                   length(isApproach))*100,
            "approachWin" = (length(which(isApproach == 1 & shotHitBy == player & is.na(isWinner) & isPointEnd == 1)) /
                               length(isApproach))*100,
            "approachVolleyWin" = (length(which(isApproach == 1 & shotHitBy == player & is.na(isWinner) & 
                                                  isPointEnd == 1 & isVolley == 1)) /
                                     length(isApproach))*100,
            "approachVolleyLose" = (length(which(isApproach == 1 & shotHitBy == player & is.na(isWinner) & 
                                                   isPointEnd != 1 & isVolley == 1)) /
                                      length(isApproach))*100)
  
  df2 <- data %>% 
    filter(isApproach == 1) %>% 
    summarise("approachFH" = (length(which((shotHitBy == player & shotFhBh == "Forehand")))) /
                (length(which(shotHitBy == player & (shotFhBh == "Forehand" | shotFhBh == "Backhand"))))*100,
              "approachBH" = (length(which((shotHitBy == player & shotFhBh == "Backhand")))) /
                (length(which(shotHitBy == player & (shotFhBh == "Forehand" | shotFhBh == "Backhand"))))*100,
              "approachFHWin" = (length(which((shotHitBy == player & shotFhBh == "Forehand" & isPointEnd == 1)))) /
                (length(which(shotHitBy == player & (shotFhBh == "Forehand" | shotFhBh == "Backhand"))))*100,
              "approachBHWin" = (length(which((shotHitBy == player & shotFhBh == "Backhand" & isPointEnd == 1)))) /
                (length(which(shotHitBy == player & (shotFhBh == "Forehand" | shotFhBh == "Backhand"))))*100)
  
  df3 <- data %>% 
    filter(isApproach == 1) %>% 
    summarise("forehandCross" = ((length(which(shotHitBy == player & shotFhBh == "Forehand" & shotDirection == "Crosscourt"))) /
                                   (length(which(shotHitBy == player & shotFhBh == "Forehand" & shotDirection == "Crosscourt")) +
                                   (length(which(shotHitBy == player & shotFhBh == "Forehand" & shotDirection == "Down the Line")))))*100,
              "forehandDL" = ((length(which(shotHitBy == player & shotFhBh == "Forehand" & shotDirection == "Down the Line"))) /
                                   (length(which(shotHitBy == player & shotFhBh == "Forehand" & shotDirection == "Crosscourt")) +
                                   (length(which(shotHitBy == player & shotFhBh == "Forehand" & shotDirection == "Down the Line")))))*100,
              "backhandCross" = ((length(which(shotHitBy == player & shotFhBh == "Backhand" & shotDirection == "Crosscourt"))) /
                                   (length(which(shotHitBy == player & shotFhBh == "Backhand" & shotDirection == "Crosscourt")) +
                                   (length(which(shotHitBy == player & shotFhBh == "Backhand" & shotDirection == "Down the Line")))))*100,
              "backhandDL" = ((length(which(shotHitBy == player & shotFhBh == "Backhand" & shotDirection == "Down the Line"))) /
                                   (length(which(shotHitBy == player & shotFhBh == "Backhand" & shotDirection == "Crosscourt")) +
                                   (length(which(shotHitBy == player & shotFhBh == "Backhand" & shotDirection == "Down the Line")))))*100)
  
  
  df <- data.frame(df1, df2, df3)
  data.frame("Stat" = colnames(df),
             "Percent" = round(as.numeric(unlist(df[1,])), digits = 1))
}

# Approach Shot Count Function
approach_count <- function(data, player){
  data %>% 
    filter(shotHitBy == player) %>% 
    reframe("approachShotCount" = length(which(isApproach == 1)),
            "approachVolleyCount" = length(which(isApproach == 1 & isVolley == 1)))
}

# Approach Shot Plot Function
approach_plot <- function(data){
  data$Stat <- factor(c("Approach %", "Approach Win %", "Volley Win %", "Volley Lose %", 
                        "FH %", "BH %", "FH Win %", "BH Win %", "FH CC %", "FH DTL %", "BH CC %", "BH DTL %"))
  data$Category <- c(rep("Approach Win", 4), rep("Forehand vs Backhand", 4), rep("Forehand", 2), rep("Backhand", 2))
  
  ggplot(data[9:12,], aes(x = Category, y = Percent, fill = Stat)) + 
    geom_bar(position="stack", stat="identity") +
    geom_text(aes(label = Percent), position = position_stack(vjust = 0.5), cex = 6) +
    geom_text(aes(label = Stat), position = position_stack(vjust = 0.5), vjust = 3) +
    scale_fill_manual(values = c("#2D68C4", "#F2A900", "#2D68C4", "#F2A900")) +
    theme(legend.position = "none", 
          plot.title = element_text(hjust = 0.5),
          axis.title.y = element_blank(),
          panel.background = element_rect(fill = "white"),
          panel.grid.major.x = element_line(color = "gray95"),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank()) +
    labs(title = "Approach FH vs BH, CC vs DTL") +
    coord_flip()
}

temp <- approach_table(shotdata, player1)
temp
approach_count(shotdata, player1)
approach_plot(temp)
```

# Break Point Won Proportion
```{r}
breakPoint <- function(match, playerName) {
  # Clean data for all break points for UCLA player
  bpData <- match[((match$returnerName == playerName) & (match$isBreakPoint == "True")), ]
  isSet1 <- bpData$setNum == 1
  isSet2 <- bpData$setNum == 2
  isSet3 <- bpData$setNum == 3
  bpData$breakPointWon <- bpData$pointWonBy == playerName
  
  
  # Set 1
  set1Data <- bpData[isSet1, ]
  set1_DF <- data.frame(sum(set1Data$breakPointWon), paste0(as.character(round(sum(set1Data$breakPointWon) / nrow(set1Data) * 100, 2)), "%"))
  colnames(set1_DF) <- c("Break Points Won", "Break Point Win Percentage")
  
  # Set 2
  set2Data <- bpData[isSet2, ]
  set2_DF <- data.frame(sum(set2Data$breakPointWon), paste0(as.character(round(sum(set2Data$breakPointWon) / nrow(set2Data) * 100, 2)), "%"))
  colnames(set2_DF) <- c("Break Points Won", "Break Point Win Percentage")
  bpDF <- rbind(set1_DF, set2_DF)
  rownames(bpDF) <- c("Set 1", "Set 2")
  
  # Set 3 
  if (any(isSet3)) {
    set3Data <- bpData[isSet3, ]
    set3_DF <- data.frame(sum(set3Data$breakPointWon), paste0(as.character(round(sum(set3Data$breakPointWon) / nrow(set3Data) * 100, 2)), "%"))
    colnames(set3_DF) <- c("Break Points Won", "Break Point Win Percentage")
    rownames(set3_DF) <- "Set 3"
    bpDF <- rbind(bpDF, set3_DF)
  }
  
  # Full Match
  total_DF <- data.frame(sum(bpData$breakPointWon), paste0(as.character(round(sum(bpData$breakPointWon) / nrow(bpData) * 100, 2)), "%"))
  colnames(total_DF) <- c("Break Points Won", "Break Point Win Percentage")
  rownames(total_DF) <- "Full Match"
  bpDF <- rbind(bpDF, total_DF)
  bpDF
}

breakPoint(pointdata, "Spencer Johnson")
```

# Proportion of Errors for Forehand/Backhand
```{r}
errorPropTable <- function(match, playerName) {
  # Forehand
  fore <- match[((match$pointWonBy != playerName) & (match$errorType != "") & (match$player1LastShotFhBh == "Forehand")), ]
  isWide <- fore$errorType == "Wide Right" | fore$errorType == "Wide Left" 
  isLong <- fore$errorType == "Long" 
  isNet <- fore$errorType == "Net" 
  fore$errorType[isNet] <- "Net"
  fore$errorType[isLong] <- "Long"
  fore$errorType[isWide] <- "Wide"
  errorTypeNames <- c("Net", "Wide", "Long")
  fore$errorType <- factor(fore$errorType, levels = errorTypeNames)
  
  # Backhand
  back <- match[((match$pointWonBy!= playerName) & (match$errorType != "") & (match$player1LastShotFhBh == "Backhand")), ]
  isWide <- back$errorType == "Wide Right" | back$errorType == "Wide Left" 
  isLong <- back$errorType == "Long" 
  isNet <- back$errorType == "Net" 
  back$errorType[isNet] <- "Net"
  back$errorType[isLong] <- "Long"
  back$errorType[isWide] <- "Wide"
  back$errorType <- factor(back$errorType, levels = errorTypeNames)
  
  # Creating Tables
  foreCountTable <- round(table(fore$errorType), 0)
  forePropTable <- paste0(as.character(round(table(fore$errorType) / nrow(fore) * 100, 2)), "%")
  backCountTable <- round(table(back$errorType), 0)
  backPropTable <- paste0(as.character(round(table(back$errorType) / nrow(back) * 100, 2)), "%")
  table <- rbind(foreCountTable, backCountTable, forePropTable, backPropTable)
  rownames(table)
  rownames(table) <- c("Forehand: Error Count", "Backhand: Error Count", "Forehand: Error Percentage", "Backhand: Error Percentage")
  table
}

errorPropTable(pointdata, "Spencer Johnson")
```

# Returns on Serves Table
```{r}
#Create new Data Frame for Sorted Data
df_CLEANED = data.frame()

#Delete all the rows where UCLA is Serving
for (i in 1:nrow(shotdata)){
  row <- shotdata[i,]
  if (row["serverName"] == player2)
  {
    df_CLEANED <- rbind(df_CLEANED, row)
  }
}

#Create new Data Frame with one column for number of attempted returns second for number of successful returns
column_headers <- c("tServesAd","tServesDeuce", "bodyServesAd", "bodyServesDeuce", "wideServesAd", "wideServesDeuce", "totals")
row_names <- c("successfulReturns", "attemptedReturns")

df_SERVES <- data.frame(matrix(0, nrow = 2, ncol = length(column_headers)))
colnames(df_SERVES) <- column_headers
row.names(df_SERVES) <- row_names

new_row <- c(0,0,0,0,0,0,0)
df_SERVES <- rbind(df_SERVES, new_row)

#Get the Attempted Returns & Successful Returns on First Serve
for (i in 1:nrow(df_CLEANED)){
  
  row <- df_CLEANED[i,] #this row gets data for opponents serve type
  next_row = df_CLEANED[i+1,] #this row gets data for UCLA player's return
  
  if (!is.na(row["isPointStart"]) && is.na(row["isPointEnd"])){
    
    serveZone <- df_CLEANED[i,"firstServeZone"]
    side <- df_CLEANED[i, "side"]
    
    #classify the zones:
    if(serveZone == "T"){
      serveZone <- "tServes"
    }
    else if(serveZone == "Body"){
      serveZone <- "bodyServes"
    }
    else if(serveZone == "Wide"){
      serveZone <- "wideServes"
    }
    else{
      #skip data collection if faulty data
      next
    }
    
    category = paste(serveZone, side, sep = "")
    
    if(is.na(next_row["isErrorNet"]) && is.na(next_row["isErrorLong"]) && is.na(next_row["isErrorLong"]) &&
       is.na(next_row["isErrorWideR"]) && is.na(next_row["isErrorWideL"]))
    {
      df_SERVES["successfulReturns",category] <- df_SERVES["successfulReturns",category] + 1
    }
    
    df_SERVES["attemptedReturns",category] <- df_SERVES["attemptedReturns",category] + 1
  }
}

#Get the Sums and Set to Total
successful_sum <- rowSums(df_SERVES["successfulReturns",])
attempt_sum <- rowSums(df_SERVES["attemptedReturns",])
df_SERVES["successfulReturns","totals"] <- successful_sum
df_SERVES["attemptedReturns","totals"] <- attempt_sum

#Delete last row
df_SERVES <- df_SERVES[-nrow(df_SERVES), ]

#Change row names
rownames(df_SERVES) <- c("Successful Returns", "Attempted Returns")

#Create a Table for the Results
gt_tbl <- gt(df_SERVES, rownames_to_stub = TRUE)
gt_tbl <- tab_header(gt_tbl, title=md("**Returns on Serves**"), subtitle = NULL, preheader = NULL)
gt_tbl <- tab_source_note(gt_tbl, source_note=paste0(player1, " vs ", player2))
gt_tbl <- cols_label(gt_tbl, tServesAd = 'Ad', tServesDeuce = 'Deuce', bodyServesAd = 'Ad', 
                     bodyServesDeuce = 'Deuce', wideServesAd = 'Ad', wideServesDeuce = 'Deuce', totals = 'Totals')
gt_tbl <- tab_options(gt_tbl, data_row.padding = px(10), column_labels.padding = px(7), 
                      column_labels.padding.horizontal = px(15), container.padding.y = px(15), 
                      heading.padding = px(7), grand_summary_row.padding.horizontal = px(10))
gt_tbl <- grand_summary_rows(gt_tbl, columns = everything(), fns = list('Return Rate' = ~((sum(.[1]) / sum(.[2]) ))), 
                             fmt = ~fmt_percent(., decimals = 1) )
gt_tbl <- cols_align(gt_tbl,align=c("center"),columns = everything())

#Create Spanners
gt_tbl <- tab_spanner(gt_tbl,label = md('**T-Serves**'),columns = 2:3)
gt_tbl <- tab_spanner(gt_tbl,label = md('**Body Serves**'),columns = 4:5)
gt_tbl <- tab_spanner(gt_tbl,label = md('**Wide Serves**'),columns = 6:7)

# Show the gt Table
gt_tbl
```

